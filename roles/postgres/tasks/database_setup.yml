---
# Configure default PostgreSQL superuser using direct SQL
- name: Set password for PostgreSQL superuser (postgres)
  shell: |
    sudo -u postgres psql -c "ALTER USER \"{{ postgres_superuser }}\" PASSWORD '{{ postgres_superuser_password }}';"
  changed_when: true
  no_log: true

# Create custom admin user with full privileges
- name: Create PostgreSQL admin user (psqladmin)
  shell: |
    sudo -u postgres psql -c "CREATE USER \"{{ postgres_admin_user }}\" WITH PASSWORD '{{ postgres_admin_password }}' CREATEDB CREATEROLE LOGIN;" || \
    sudo -u postgres psql -c "ALTER USER \"{{ postgres_admin_user }}\" PASSWORD '{{ postgres_admin_password }}';"
  changed_when: true
  no_log: true

# Create application-specific user
- name: Create PostgreSQL application user
  shell: |
    sudo -u postgres psql -c "CREATE USER \"{{ postgres_app_user }}\" WITH PASSWORD '{{ postgres_app_password }}' LOGIN;" || \
    sudo -u postgres psql -c "ALTER USER \"{{ postgres_app_user }}\" PASSWORD '{{ postgres_app_password }}';"
  changed_when: true
  no_log: true

# Create application-specific user readonly (if defined)
- name: Create PostgreSQL application readonly user
  shell: |
    sudo -u postgres psql -c "CREATE USER \"{{ postgres_app_user_readonly }}\" WITH PASSWORD '{{ postgres_app_password_readonly }}' LOGIN;" || \
    sudo -u postgres psql -c "ALTER USER \"{{ postgres_app_user_readonly }}\" PASSWORD '{{ postgres_app_password_readonly }}';"
  changed_when: true
  no_log: true
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""

# Create application database
- name: Create PostgreSQL application database
  shell: |
    sudo -u postgres psql -c "SELECT 1 FROM pg_database WHERE datname='{{ postgres_app_db }}';" | grep -q 1 || \
    sudo -u postgres createdb "{{ postgres_app_db }}" -O "{{ postgres_app_user }}"
  changed_when: true

# Grant privileges to application user on their database
- name: Grant all privileges to application user on their database
  shell: |
    sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE \"{{ postgres_app_db }}\" TO \"{{ postgres_app_user }}\";"
  changed_when: true

# Grant read-only privileges to readonly user
- name: Grant CONNECT privilege to readonly user on database
  shell: |
    sudo -u postgres psql -c "GRANT CONNECT ON DATABASE \"{{ postgres_app_db }}\" TO \"{{ postgres_app_user_readonly }}\";"
  changed_when: true
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""

- name: Grant USAGE privilege to readonly user on schema
  shell: |
    sudo -u postgres psql -d "{{ postgres_app_db }}" -c "GRANT USAGE ON SCHEMA public TO \"{{ postgres_app_user_readonly }}\";"
  changed_when: true
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""

- name: Grant SELECT on all existing tables to readonly user
  shell: |
    sudo -u postgres psql -d "{{ postgres_app_db }}" -c "GRANT SELECT ON ALL TABLES IN SCHEMA public TO \"{{ postgres_app_user_readonly }}\";"
  changed_when: true
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""

- name: Grant SELECT on all future tables to readonly user (for app user)
  shell: |
    sudo -u postgres psql -d "{{ postgres_app_db }}" -c "ALTER DEFAULT PRIVILEGES FOR ROLE \"{{ postgres_app_user }}\" IN SCHEMA public GRANT SELECT ON TABLES TO \"{{ postgres_app_user_readonly }}\";"
  changed_when: true
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""

- name: Grant SELECT on all future tables to readonly user (for DBA admin)
  shell: |
    sudo -u postgres psql -d "{{ postgres_app_db }}" -c "ALTER DEFAULT PRIVILEGES FOR ROLE \"{{ postgres_admin_user }}\" IN SCHEMA public GRANT SELECT ON TABLES TO \"{{ postgres_app_user_readonly }}\";"
  changed_when: true
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""

- name: Grant SELECT on all existing sequences to readonly user
  shell: |
    sudo -u postgres psql -d "{{ postgres_app_db }}" -c "GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO \"{{ postgres_app_user_readonly }}\";"
  changed_when: true
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""

- name: Grant SELECT on all future sequences to readonly user (for app user)
  shell: |
    sudo -u postgres psql -d "{{ postgres_app_db }}" -c "ALTER DEFAULT PRIVILEGES FOR ROLE \"{{ postgres_app_user }}\" IN SCHEMA public GRANT SELECT ON SEQUENCES TO \"{{ postgres_app_user_readonly }}\";"
  changed_when: true
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""

- name: Grant SELECT on all future sequences to readonly user (for DBA admin)
  shell: |
    sudo -u postgres psql -d "{{ postgres_app_db }}" -c "ALTER DEFAULT PRIVILEGES FOR ROLE \"{{ postgres_admin_user }}\" IN SCHEMA public GRANT SELECT ON SEQUENCES TO \"{{ postgres_app_user_readonly }}\";"
  changed_when: true
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""