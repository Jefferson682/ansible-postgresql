---
# Main task file for PostgreSQL role

- name: Check the operating system
  debug:
    msg: "Detected OS family: {{ ansible_facts['os_family'] }}"

- name: Include tasks for RedHat-based systems
  include_tasks: install_redhat.yml
  when: ansible_facts['os_family'] == 'RedHat'

- name: Include tasks for Debian-based systems
  include_tasks: install_debian.yml
  when: ansible_facts['os_family'] == 'Debian'

- name: Check existing PostgreSQL installation
  include_tasks: check_existing.yml

- name: Configure system hostname
  include_tasks: hostname.yml


- name: Add PostgreSQL repository (Debian)
  include_tasks: add_repo_debian.yml
  when: ansible_facts['os_family'] == 'Debian'

- name: Add PostgreSQL repository (RedHat)
  include_tasks: add_repo_redhat.yml
  when: ansible_facts['os_family'] == 'RedHat'

- name: Prepare storage
  include_tasks: storage.yml

- name: Install PostgreSQL packages
  include_tasks: install_package.yml

- name: Configure service before initialization
  include_tasks: service.yml

- name: Initialize database
  include_tasks: init_db.yml

- name: Start PostgreSQL service
  include_tasks: start_service.yml

- name: Setup database users and databases (Debian)
  include_tasks: database_setup_debian.yml
  when: ansible_facts['os_family'] == 'Debian'

- name: Setup database users and databases (RedHat)
  include_tasks: database_setup.yml
  when: ansible_facts['os_family'] == 'RedHat'

- name: Configure firewall for PostgreSQL access
  include_tasks: firewall.yml

- name: Display execution summary
  include_tasks: summary.yml
