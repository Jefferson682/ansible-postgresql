# Ensure the postgres user exists
- name: Ensure postgres user exists (Debian)
  user:
    name: postgres
    state: present
    shell: /bin/bash
  when: ansible_facts['os_family'] == 'Debian'

# Ensure the socket directory exists and is owned by postgres
- name: Ensure /var/run/postgresql exists and is owned by postgres (Debian)
  file:
    path: /var/run/postgresql
    state: directory
    owner: postgres
    group: postgres
    mode: '0775'
  when: ansible_facts['os_family'] == 'Debian'

# Ensure PostgreSQL is running in the custom data directory before running psql commands
- name: Start PostgreSQL standalone (custom data dir, Debian workaround)
  shell: |
    sudo -u postgres /usr/lib/postgresql/{{ postgres_version }}/bin/pg_ctl -D {{ postgres_data_dir }} -l /tmp/postgres.log start
  args:
    creates: "{{ postgres_data_dir }}/postmaster.pid"
  become: yes
  become_user: root
  when: ansible_facts['os_family'] == 'Debian'



# Debian/Ubuntu: Use become_user: postgres, no sudo -u, and prefer Ansible modules

- name: Ensure local postgres uses trust for password change
  lineinfile:
    path: "{{ postgres_data_dir }}/pg_hba.conf"
    regexp: '^local\s+all\s+postgres\s+'
    line: 'local   all             postgres                                trust'
    backrefs: yes
  notify: Restart PostgreSQL (Debian)

- name: Set password for PostgreSQL superuser (postgres) [Debian workaround]
  shell: |
    sudo -u postgres psql -c "ALTER USER \"{{ postgres_superuser }}\" PASSWORD '{{ postgres_superuser_password }}';"
  changed_when: true
  become: yes
  become_user: root
  register: set_superuser_pw
  notify: Restart PostgreSQL (Debian)

- name: Revert local postgres to peer authentication
  lineinfile:
    path: "{{ postgres_data_dir }}/pg_hba.conf"
    regexp: '^local\s+all\s+postgres\s+'
    line: 'local   all             postgres                                peer'
    backrefs: yes
  when: set_superuser_pw is changed
  notify: Restart PostgreSQL (Debian)

- name: Create PostgreSQL admin user (psqladmin) [Debian workaround]
  shell: |
    sudo -u postgres psql -tc "SELECT 1 FROM pg_roles WHERE rolname='{{ postgres_admin_user }}';" | grep -q 1 || \
    sudo -u postgres psql -c "CREATE USER \"{{ postgres_admin_user }}\" WITH PASSWORD '{{ postgres_admin_password }}' CREATEDB CREATEROLE LOGIN;"
    sudo -u postgres psql -c "ALTER USER \"{{ postgres_admin_user }}\" PASSWORD '{{ postgres_admin_password }}';"
  changed_when: true
  become: yes
  become_user: root

- name: Create PostgreSQL application user [Debian workaround]
  shell: |
    sudo -u postgres psql -tc "SELECT 1 FROM pg_roles WHERE rolname='{{ postgres_app_user }}';" | grep -q 1 || \
    sudo -u postgres psql -c "CREATE USER \"{{ postgres_app_user }}\" WITH PASSWORD '{{ postgres_app_password }}' LOGIN;"
    sudo -u postgres psql -c "ALTER USER \"{{ postgres_app_user }}\" PASSWORD '{{ postgres_app_password }}';"
  changed_when: true
  become: yes
  become_user: root

- name: Create PostgreSQL application readonly user [Debian workaround]
  shell: |
    sudo -u postgres psql -tc "SELECT 1 FROM pg_roles WHERE rolname='{{ postgres_app_user_readonly }}';" | grep -q 1 || \
    sudo -u postgres psql -c "CREATE USER \"{{ postgres_app_user_readonly }}\" WITH PASSWORD '{{ postgres_app_password_readonly }}' LOGIN;"
    sudo -u postgres psql -c "ALTER USER \"{{ postgres_app_user_readonly }}\" PASSWORD '{{ postgres_app_password_readonly }}';"
  changed_when: true
  become: yes
  become_user: root
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""

- name: Create PostgreSQL application database [Debian workaround]
  shell: |
    sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname='{{ postgres_app_db }}';" | grep -q 1 || \
    sudo -u postgres createdb "{{ postgres_app_db }}" -O "{{ postgres_app_user }}"
  changed_when: true
  become: yes
  become_user: root

- name: Grant all privileges to application user on their database [Debian workaround]
  shell: |
    sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE \"{{ postgres_app_db }}\" TO \"{{ postgres_app_user }}\";"
  changed_when: true
  become: yes
  become_user: root

- name: Grant CONNECT privilege to readonly user on database [Debian workaround]
  shell: |
    sudo -u postgres psql -c "GRANT CONNECT ON DATABASE \"{{ postgres_app_db }}\" TO \"{{ postgres_app_user_readonly }}\";"
  changed_when: true
  become: yes
  become_user: root
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""

- name: Grant USAGE privilege to readonly user on schema [Debian workaround]
  shell: |
    sudo -u postgres psql -d "{{ postgres_app_db }}" -c "GRANT USAGE ON SCHEMA public TO \"{{ postgres_app_user_readonly }}\";"
  changed_when: true
  become: yes
  become_user: root
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""

- name: Grant SELECT on all existing tables to readonly user [Debian workaround]
  shell: |
    sudo -u postgres psql -d "{{ postgres_app_db }}" -c "GRANT SELECT ON ALL TABLES IN SCHEMA public TO \"{{ postgres_app_user_readonly }}\";"
  changed_when: true
  become: yes
  become_user: root
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""

- name: Grant SELECT on all future tables to readonly user (for app user) [Debian workaround]
  shell: |
    sudo -u postgres psql -d "{{ postgres_app_db }}" -c "ALTER DEFAULT PRIVILEGES FOR ROLE \"{{ postgres_app_user }}\" IN SCHEMA public GRANT SELECT ON TABLES TO \"{{ postgres_app_user_readonly }}\";"
  changed_when: true
  become: yes
  become_user: root
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""

- name: Grant SELECT on all future tables to readonly user (for DBA admin) [Debian workaround]
  shell: |
    sudo -u postgres psql -d "{{ postgres_app_db }}" -c "ALTER DEFAULT PRIVILEGES FOR ROLE \"{{ postgres_admin_user }}\" IN SCHEMA public GRANT SELECT ON TABLES TO \"{{ postgres_app_user_readonly }}\";"
  changed_when: true
  become: yes
  become_user: root
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""

- name: Grant SELECT on all existing sequences to readonly user [Debian workaround]
  shell: |
    sudo -u postgres psql -d "{{ postgres_app_db }}" -c "GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO \"{{ postgres_app_user_readonly }}\";"
  changed_when: true
  become: yes
  become_user: root
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""

- name: Grant SELECT on all future sequences to readonly user (for app user) [Debian workaround]
  shell: |
    sudo -u postgres psql -d "{{ postgres_app_db }}" -c "ALTER DEFAULT PRIVILEGES FOR ROLE \"{{ postgres_app_user }}\" IN SCHEMA public GRANT SELECT ON SEQUENCES TO \"{{ postgres_app_user_readonly }}\";"
  changed_when: true
  become: yes
  become_user: root
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""

- name: Grant SELECT on all future sequences to readonly user (for DBA admin) [Debian workaround]
  shell: |
    sudo -u postgres psql -d "{{ postgres_app_db }}" -c "ALTER DEFAULT PRIVILEGES FOR ROLE \"{{ postgres_admin_user }}\" IN SCHEMA public GRANT SELECT ON SEQUENCES TO \"{{ postgres_app_user_readonly }}\";"
  changed_when: true
  become: yes
  become_user: root
  when: postgres_app_user_readonly is defined and postgres_app_user_readonly != ""
